---
import Layout from '../components/Layout.astro';
---

<Layout title="Setup – ED Rare Router">
  <div class="max-w-xl mx-auto px-4 py-10">
    <h1 class="text-2xl font-semibold text-gray-100 mb-2">First-run setup</h1>
    <p class="text-gray-400 text-sm mb-6">
      Enter your paths and keys below. This creates <code class="bg-gray-800 px-1 rounded">.config.json</code> in the project root (not shared in the repo).
    </p>

    <form id="setup-form" class="space-y-5">
      <div>
        <label for="edsmUserAgent" class="block text-sm font-medium text-gray-300 mb-1">
          EDSM User-Agent (contact for API)
        </label>
        <input
          type="text"
          id="edsmUserAgent"
          name="edsmUserAgent"
          placeholder="ED-Rare-Router/1.0 (contact: your@email.com)"
          class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-amber-500"
        />
      </div>

      <div>
        <label for="dataDir" class="block text-sm font-medium text-gray-300 mb-1">
          Data directory <span class="text-gray-500">(optional, blank = ./data)</span>
        </label>
        <input
          type="text"
          id="dataDir"
          name="dataDir"
          placeholder="C:\path\to\data or /path/to/data"
          class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-amber-500"
        />
      </div>

      <div>
        <span class="block text-sm font-medium text-gray-300 mb-2">API keys (optional)</span>
        <div class="space-y-2">
          <div>
            <label for="apiKey_edsm" class="sr-only">EDSM API key</label>
            <input
              type="password"
              id="apiKey_edsm"
              name="apiKey_edsm"
              placeholder="EDSM API key"
              autocomplete="off"
              class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-amber-500"
            />
          </div>
          <div>
            <label for="apiKey_eddn" class="sr-only">EDDN API key</label>
            <input
              type="password"
              id="apiKey_eddn"
              name="apiKey_eddn"
              placeholder="EDDN API key"
              autocomplete="off"
              class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-amber-500"
            />
          </div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <input
          type="checkbox"
          id="overwrite"
          name="overwrite"
          class="rounded border-gray-600 bg-gray-800 text-amber-500 focus:ring-amber-500"
        />
        <label for="overwrite" class="text-sm text-gray-400">
          Replace existing config (check if you already have .config.json and want to update it)
        </label>
      </div>

      <div id="setup-message" class="text-sm hidden"></div>

      <div class="flex gap-3">
        <button
          type="submit"
          id="setup-submit"
          class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-gray-900 font-medium rounded transition-colors"
        >
          Save config
        </button>
        <a
          href="/"
          class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded transition-colors"
        >
          Cancel
        </a>
      </div>
    </form>
  </div>

  <script>
    (function () {
      const form = document.getElementById('setup-form') as HTMLFormElement;
      const messageEl = document.getElementById('setup-message') as HTMLDivElement;
      const submitBtn = document.getElementById('setup-submit') as HTMLButtonElement;

      function showMessage(text: string, isError: boolean) {
        messageEl.textContent = text;
        messageEl.className = `text-sm ${isError ? 'text-red-400' : 'text-green-400'}`;
        messageEl.classList.remove('hidden');
      }

      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!submitBtn) return;
        submitBtn.disabled = true;
        messageEl.classList.add('hidden');

        const edsmUserAgent = (form.querySelector('#edsmUserAgent') as HTMLInputElement)?.value?.trim() || undefined;
        const dataDirRaw = (form.querySelector('#dataDir') as HTMLInputElement)?.value?.trim();
        const dataDir = dataDirRaw === '' ? null : dataDirRaw;
        const apiKeyEdsm = (form.querySelector('#apiKey_edsm') as HTMLInputElement)?.value?.trim();
        const apiKeyEddn = (form.querySelector('#apiKey_eddn') as HTMLInputElement)?.value?.trim();
        const overwrite = (form.querySelector('#overwrite') as HTMLInputElement)?.checked ?? false;

        const apiKeys: Record<string, string> = {};
        if (apiKeyEdsm) apiKeys.edsm = apiKeyEdsm;
        if (apiKeyEddn) apiKeys.eddn = apiKeyEddn;

        const body: Record<string, unknown> = {
          edsmUserAgent: edsmUserAgent || undefined,
          dataDir,
          overwrite,
        };
        if (Object.keys(apiKeys).length > 0) body.apiKeys = apiKeys;

        try {
          const res = await fetch('/api/setup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });
          const data = await res.json().catch(() => ({}));

          if (res.status === 201) {
            showMessage('Config saved. Redirecting…', false);
            window.location.href = '/';
            return;
          }
          if (res.status === 409) {
            showMessage(data.error || 'Config already exists. Check "Replace existing config" to update.', true);
          } else {
            showMessage(data.error || data.details || 'Failed to save config.', true);
          }
        } catch (err) {
          showMessage('Network error. Is the server running?', true);
        } finally {
          submitBtn.disabled = false;
        }
      });
    })();
  </script>
</Layout>
